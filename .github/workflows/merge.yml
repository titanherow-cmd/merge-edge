name: Merge macros (persisted counter, scan all folders, zip top-level)

on:
  workflow_dispatch:
    inputs:
      versions:
        description: 'How many versions per group'
        required: true
        default: '6'
      within_max_time:
        description: 'Intra-file max pause time (seconds) - Used for TIME SENSITIVE folders only'
        required: true
        default: '33'
      within_max_pauses:
        description: 'Max intra-file pauses (0-3 randomly chosen)'
        required: true
        default: '3'
      between_max_time:
        description: 'Inter-file max pause time (seconds)'
        required: true
        default: '18'
      exclude_count:
        description: 'Max files to randomly exclude per version'
        required: true
        default: '10'
      target_minutes:
        description: 'Target duration per merged file in minutes (will reuse files if needed)'
        required: true
        default: '25'
      disable_time_sensitive_pauses:
        description: 'Disable intra/inter pauses for TIME SENSITIVE folders (only disables short pauses, long AFK always disabled)'
        required: false
        type: boolean
        default: false

jobs:
  merge:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
            
      - name: Install dependencies
        run: pip install -r requirements.txt || true
        
      - name: Get current BUNDLE_SEQ
        id: bundle_seq_read
        run: |
          if [ -f .github/merge_bundle_counter.txt ]; then
            BUNDLE_SEQ=$(cat .github/merge_bundle_counter.txt)
            echo "BUNDLE_SEQ=$BUNDLE_SEQ" >> "$GITHUB_ENV"
          else
            echo "BUNDLE_SEQ=1" >> "$GITHUB_ENV"
          fi
          
      - name: Execute macro merge script
        run: |
          python merge_macros.py \
            --versions ${{ github.event.inputs.versions }} \
            --within-max-time '${{ github.event.inputs.within_max_time }}' \
            --within-max-pauses ${{ github.event.inputs.within_max_pauses }} \
            --between-max-time '${{ github.event.inputs.between_max_time }}' \
            --exclude-count ${{ github.event.inputs.exclude_count }} \
            --target-minutes ${{ github.event.inputs.target_minutes }}
            
      - name: Create ZIP artifact
        run: |
          BUNDLE="${BUNDLE_SEQ:-1}"
          
          # Check if the counter file exists and read the updated counter (post-script execution)
          if [ -f .github/merge_bundle_counter.txt ]; then
            BUNDLE=$(cat .github/merge_bundle_counter.txt 2>/dev/null || echo "")
            BUNDLE=${BUNDLE:-1}
          fi
          
          OUTPUT_BASE="merged_bundle_${BUNDLE}"
          
          echo "Creating zip: ${OUTPUT_BASE}.zip from output/${OUTPUT_BASE}"
          
          if [ -d "output/${OUTPUT_BASE}" ]; then
            if [ "$(ls -A output/${OUTPUT_BASE})" ]; then
              (cd output && zip -r "../${OUTPUT_BASE}.zip" "${OUTPUT_BASE}") || true
              ls -lh "${OUTPUT_BASE}.zip" || true
              echo "ZIP_NAME=${OUTPUT_BASE}.zip" >> "$GITHUB_ENV"
              echo "✅ Successfully created zip with $(find output/${OUTPUT_BASE} -type f | wc -l) files"
            else
              echo "⚠️ Output directory is empty"
              touch empty_placeholder.txt
              zip "${OUTPUT_BASE}.zip" empty_placeholder.txt || true
              echo "ZIP_NAME=${OUTPUT_BASE}.zip" >> "$GITHUB_ENV"
            fi
          else
            echo "❌ No 'output/${OUTPUT_BASE}' found; creating empty zip fallback"
            touch empty_placeholder.txt
            zip "${OUTPUT_BASE}.zip" empty_placeholder.txt || true
            echo "ZIP_NAME=${OUTPUT_BASE}.zip" >> "$GITHUB_ENV"
          fi
          
      - name: Upload merged ZIP artifact
        if: always()
        uses: actions/upload-artifact@v4 # <-- **CRITICAL FIX: Updated to v4**
        with:
          name: merged_macros_${{ env.BUNDLE_SEQ }}
          path: ${{ env.ZIP_NAME }}
